#!/bin/bash

# Closes all opened SSH tunnels
# Usage: close-all

# Source helper functions
source "$(dirname "$0")/_helpers.sh"

if [[ "$1" == "-h" || "$1" == "--help" ]]; then
    echo "Usage: $0"
    echo ""
    echo "Closes all SSH tunnels (kills all autossh processes)"
    echo ""
    echo "Examples:"
    echo "  $0               # Close all SSH tunnels"
    echo "  $0 --help        # Show this help message"
    exit 0
fi

# Check if autossh processes exist and close them
if pgrep -q "autossh"; then
    echo "Closing all SSH tunnels..."
    tunnel_data=$(get_active_tunnels)
    if [[ -n "$tunnel_data" ]]; then
        echo "Tunnels closed:"
        echo "$tunnel_data" | while IFS='|' read -r pid port host cmd; do
            echo "PID: $pid | Port: $port | Host: $host | Command: $cmd"
        done
    fi
    pkill "autossh"
    echo "All SSH tunnels closed."
else
    echo "No active SSH tunnels found."
fi
