#!/bin/bash

# Opens SSH tunnels - interactive or direct mode
# Usage: open [port] [local_port remote_port] [host]

# Source helper functions
source "$(dirname "$0")/_helpers.sh"

if [[ "$1" == "-h" || "$1" == "--help" ]]; then
    echo "Usage: $0 [local_port] [remote_port] [host]"
    echo ""
    echo "Opens SSH tunnel forwarding local port to remote port on host"
    echo ""
    echo "Interactive mode (no arguments):"
    echo "  - Select host from SSH config"
    echo "  - Enter port (maps to same local port)"
    echo "  - Handles port conflicts automatically"
    echo ""
    echo "Direct mode examples:"
    echo "  $0 80 myserver                    # Remote port 80 -> local port 80"
    echo "  $0 8080 80 myserver              # Local 8080 -> remote 80"
    echo "  $0 3000 3000 dev-server          # Local 3000 -> remote 3000"
    echo ""
    echo "Prerequisites:"
    echo "  - fzf (for interactive host selection)"
    echo "  - autossh"
    echo "  - SSH config with host definitions"
    exit 0
fi

# Function to get random available port
get_random_port() {
    local port
    while true; do
        port=$(shuf -i 49152-65535 -n 1)
        if ! lsof -i ":$port" >/dev/null 2>&1; then
            echo "$port"
            return
        fi
    done
}

# Function to handle port conflicts
handle_port_conflict() {
    local requested_port="$1"
    echo "Error: Port $requested_port is already in use" >&2
    lsof -i ":$requested_port" >&2
    echo "" >&2
    echo "Options:" >&2
    echo "1) Use random available port" >&2
    echo "2) Specify different port" >&2
    echo "3) Abort" >&2
    read -p "Choose (1/2/3): " choice

    local chosen_port
    case "$choice" in
        1)
            chosen_port=$(get_random_port)
            echo "Using random port: $chosen_port" >&2
            echo "$chosen_port"
            ;;
        2)
            read -p "Enter port: " new_port
            if lsof -i ":$new_port" >/dev/null 2>&1; then
                handle_port_conflict "$new_port"
            else
                echo "Using port: $new_port" >&2
                echo "$new_port"
            fi
            ;;
        *)
            echo "Aborted" >&2
            exit 1
            ;;
    esac
}

# Parse arguments and determine mode
case $# in
    0)  # Interactive mode
        # Check for fzf
        if ! command -v fzf >/dev/null 2>&1; then
            echo "Error: fzf is required for interactive mode" >&2
            exit 1
        fi

        # Get hosts from SSH config
        hosts=$(grep -E "^Host " ~/.ssh/config 2>/dev/null | awk '{print $2}' | grep -v '\*' | sort -u)
        if [[ -z "$hosts" ]]; then
            echo "Error: No hosts found in ~/.ssh/config" >&2
            exit 1
        fi

        # Select host with dig preview
        host=$(echo "$hosts" | fzf --prompt="Select host: " --height=80% \
            --preview-window=right:50% \
            --preview='dig {}')
        if [[ -z "$host" ]]; then
            echo "No host selected"
            exit 0
        fi

        # Get port
        read -p "Enter remote port: " remote_port
        if [[ ! "$remote_port" =~ ^[0-9]+$ ]]; then
            echo "Error: Invalid port number" >&2
            exit 1
        fi

        local_port="$remote_port"  # Default: same as remote
        ;;
    2)  # Single port mode: port host
        if [[ ! "$1" =~ ^[0-9]+$ ]]; then
            echo "Error: Invalid port number" >&2
            exit 1
        fi
        remote_port="$1"
        local_port="$1"  # Same as remote
        host="$2"
        ;;
    3)  # Full specification: local_port remote_port host
        if [[ ! "$1" =~ ^[0-9]+$ || ! "$2" =~ ^[0-9]+$ ]]; then
            echo "Error: Invalid port number" >&2
            exit 1
        fi
        local_port="$1"
        remote_port="$2"
        host="$3"
        ;;
    *)  echo "Error: Invalid number of arguments. Use -h for help." >&2
        exit 1 ;;
esac

# Handle port conflicts
if lsof -i ":$local_port" >/dev/null 2>&1; then
    if [[ $# -eq 0 ]]; then
        # Interactive mode: offer alternatives
        local_port=$(handle_port_conflict "$local_port")
    else
        # Direct mode: just error out
        echo "Error: Port $local_port is already in use"
        lsof -i ":$local_port"
        exit 1
    fi
fi

echo "Opening SSH tunnel: local:$local_port -> $host:$remote_port"

# Execute autossh command with error handling
if autossh -M 0 -f -T -N -L "127.0.0.1:${local_port}:localhost:${remote_port}" "$host"; then
    sleep 2
    # Verify tunnel is working
    if lsof -i ":$local_port" >/dev/null 2>&1; then
        echo "SSH tunnel successfully opened for '$host': local:$local_port->remote:$remote_port"

        # Try to open Firefox if web service is detected
        if command -v firefox >/dev/null 2>&1; then
            if curl --silent --connect-timeout 2 --max-time 5 "http://localhost:$local_port" >/dev/null 2>&1; then
                echo "Web service detected, opening Firefox..."
                firefox "http://localhost:$local_port" &
            fi
        fi
    else
        echo "Error: SSH tunnel failed to establish"
        exit 1
    fi
else
    echo "Error: autossh command failed"
    exit 1
fi
